<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>✅ Validaciones - Orbix Systems</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header>
    <h1>🧠 Orbix Systems</h1>
    <p>Inteligencia real para negocios reales.</p>
    <nav>
      <a href="/">Inicio</a>
      <a href="/validaciones" class="active">✅ Validaciones</a>
      <a href="/calculadora">🧮 Calculadora</a>
      <a href="/sentinel">🛡️ Sentinel</a>
      <a href="https://erp.sistemasorbix.com" target="_blank">🚀 ERP</a>
    </nav>
  </header>

  <main>
    <section class="page-header">
      <h1>✅ Sistema de Validaciones Orbix AI</h1>
      <p>Procesamos validaciones como CCSS, SUGEF y más. IA + Odoo para decisiones inteligentes.</p>
      <div class="status-indicator">
        <span id="api-status" class="status-loading">🔄 Verificando conexión con FastAPI...</span>
      </div>
    </section>

    <section class="validation-dashboard">
      <div class="stats-grid">
        <div class="stat-card">
          <h3>📊 Estadísticas de Pagos</h3>
          <div id="payment-stats" class="stats-content">
            <div class="stat-item">
              <span class="stat-label">Aprobados:</span>
              <span id="approved-count" class="stat-value">-</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Rechazados:</span>
              <span id="declined-count" class="stat-value">-</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Pendientes:</span>
              <span id="pending-count" class="stat-value">-</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Tasa de éxito:</span>
              <span id="success-rate" class="stat-value">-</span>
            </div>
          </div>
        </div>

        <div class="stat-card">
          <h3>⚡ Métricas del Sistema</h3>
          <div id="system-metrics" class="stats-content">
            <div class="stat-item">
              <span class="stat-label">CPU:</span>
              <span id="cpu-usage" class="stat-value">-</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Memoria:</span>
              <span id="memory-usage" class="stat-value">-</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Conexiones:</span>
              <span id="active-connections" class="stat-value">-</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Uptime:</span>
              <span id="uptime" class="stat-value">-</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="validation-tools">
      <div class="tools-grid">
        <div class="tool-card">
          <h3>💳 Validación de Tarjetas</h3>
          <p>Sistema de validación de tarjetas de crédito con IA integrada.</p>
          <button class="btn-primary" onclick="openFastAPIValidation()">🚀 Acceder a FastAPI</button>
        </div>

        <div class="tool-card">
          <h3>🏢 Sistema ERP Odoo</h3>
          <p>Acceso completo al sistema ERP con validaciones empresariales.</p>
          <button class="btn-primary" onclick="openOdooERP()">🏢 Acceder a Odoo</button>
        </div>

        <div class="tool-card">
          <h3>📋 Cotizador Inteligente</h3>
          <div class="cotizacion-form">
            <label>Tipo de solución:</label>
            <select id="tipo-solucion">
              <option value="validacion-ccss">Validación CCSS</option>
              <option value="validacion-sugef">Validación SUGEF</option>
              <option value="sistema-completo">Sistema Completo</option>
              <option value="integracion-erp">Integración ERP</option>
            </select>
            
            <label>Horas estimadas:</label>
            <input type="number" id="horas-estimadas" placeholder="40" min="1">
            
            <label>
              <input type="checkbox" id="cliente-banco"> Cliente es banco
            </label>
            
            <button class="btn-primary" onclick="cotizarProyecto()">💰 Cotizar</button>
            
            <div id="cotizacion-result" class="result-box">
              <h4>Cotización:</h4>
              <p id="cotizacion-valor">-</p>
              <p id="cotizacion-modelo">-</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="recent-activities">
      <h2>📈 Actividades Recientes</h2>
      <div id="activities-list" class="activities-container">
        <p>🔄 Cargando actividades...</p>
      </div>
    </section>

    <section class="api-integration">
      <h2>🔗 Integración con APIs</h2>
      <div class="integration-grid">
        <div class="integration-card">
          <h3>🐍 FastAPI (Puerto 8000)</h3>
          <p>API principal de validaciones y cotizaciones</p>
          <div class="integration-links">
            <a href="http://localhost:8000" target="_blank" class="btn-secondary">🌐 Abrir API</a>
            <a href="http://localhost:8000/docs" target="_blank" class="btn-secondary">📚 Documentación</a>
            <a href="https://github.com/yovoyTecSRL/orbix.git" target="_blank" class="btn-secondary">📦 Repositorio GitHub</a>
          </div>
        </div>
        
        <div class="integration-card">
          <h3>🏢 Odoo ERP (Puerto 8070)</h3>
          <p>Sistema empresarial completo</p>
          <div class="integration-links">
            <a href="http://localhost:8070" target="_blank" class="btn-secondary">🚀 Abrir Odoo</a>
            <p class="integration-info">Master Password: <code>orbix_master_2025</code></p>
          </div>
        </div>
        
        <div class="integration-card">
          <h3>🗃️ PostgreSQL (Puerto 5432)</h3>
          <p>Base de datos principal</p>
          <div class="integration-links">
            <button class="btn-secondary" onclick="testDatabaseConnection()">🔍 Probar Conexión</button>
            <p id="db-status" class="integration-info">Estado: No verificado</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <p>© 2025 Orbix Systems S.A. | Contacto: <a href="mailto:info@sistemasorbix.com">info@sistemasorbix.com</a></p>
  </footer>

  <script>
    // Variables globales
    const API_BASE = '/api/orbix';
    
    // Verificar conexión con FastAPI al cargar la página
    window.addEventListener('DOMContentLoaded', function() {
      checkAPIConnection();
      loadPaymentStats();
      loadSystemMetrics();
      loadRecentActivities();
      
      // Actualizar datos cada 30 segundos
      setInterval(() => {
        loadPaymentStats();
        loadSystemMetrics();
        loadRecentActivities();
      }, 30000);
    });

    async function checkAPIConnection() {
      const statusElement = document.getElementById('api-status');
      try {
        const response = await fetch(`${API_BASE}/health`);
        if (response.ok) {
          const data = await response.json();
          statusElement.textContent = `✅ ${data.service} - ${data.status}`;
          statusElement.className = 'status-online';
        } else {
          throw new Error('API no responde');
        }
      } catch (error) {
        statusElement.textContent = '❌ FastAPI desconectada (Puerto 8000)';
        statusElement.className = 'status-offline';
        console.log('FastAPI no disponible:', error.message);
      }
    }

    async function loadPaymentStats() {
      try {
        const response = await fetch(`${API_BASE}/api/payment-stats`);
        if (response.ok) {
          const data = await response.json();
          document.getElementById('approved-count').textContent = data.approved;
          document.getElementById('declined-count').textContent = data.declined;
          document.getElementById('pending-count').textContent = data.pending;
          document.getElementById('success-rate').textContent = `${data.success_rate}%`;
        }
      } catch (error) {
        console.log('Error cargando estadísticas de pagos:', error);
      }
    }

    async function loadSystemMetrics() {
      try {
        const response = await fetch(`${API_BASE}/api/metrics`);
        if (response.ok) {
          const data = await response.json();
          document.getElementById('cpu-usage').textContent = `${data.cpu_usage}%`;
          document.getElementById('memory-usage').textContent = `${data.memory_usage}%`;
          document.getElementById('active-connections').textContent = data.active_connections;
          document.getElementById('uptime').textContent = data.uptime;
        }
      } catch (error) {
        console.log('Error cargando métricas del sistema:', error);
      }
    }

    async function loadRecentActivities() {
      try {
        const response = await fetch(`${API_BASE}/api/recent-activities`);
        if (response.ok) {
          const data = await response.json();
          const container = document.getElementById('activities-list');
          container.innerHTML = data.activities.map(activity => `
            <div class="activity-item ${activity.status}">
              <div class="activity-type">${getActivityIcon(activity.type)}</div>
              <div class="activity-content">
                <p class="activity-message">${activity.message}</p>
                <small class="activity-time">Por ${activity.user} - ${new Date(activity.timestamp).toLocaleString('es-CR')}</small>
              </div>
            </div>
          `).join('');
        }
      } catch (error) {
        document.getElementById('activities-list').innerHTML = '<p>❌ Error cargando actividades</p>';
      }
    }

    function getActivityIcon(type) {
      const icons = {
        'validation': '✅',
        'login': '🔐',
        'error': '❌',
        'system': '⚙️'
      };
      return icons[type] || '📋';
    }

    async function cotizarProyecto() {
      const tipo = document.getElementById('tipo-solucion').value;
      const horas = parseInt(document.getElementById('horas-estimadas').value);
      const esBanco = document.getElementById('cliente-banco').checked;
      
      if (!horas || horas < 1) {
        alert('Por favor ingrese las horas estimadas');
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/cotizar`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            tipo_solucion: tipo,
            horas_estimadas: horas,
            cliente_es_banco: esBanco
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          document.getElementById('cotizacion-valor').textContent = `Valor: ${data.recomendacion}`;
          document.getElementById('cotizacion-modelo').textContent = `Modelo: ${data.modelo}`;
        } else {
          throw new Error('Error en la cotización');
        }
      } catch (error) {
        document.getElementById('cotizacion-valor').textContent = 'Error al cotizar';
        document.getElementById('cotizacion-modelo').textContent = 'Verifique la conexión con FastAPI';
      }
    }

    function openFastAPIValidation() {
      window.open('http://localhost:8000', '_blank');
    }

    function openOdooERP() {
      window.open('http://localhost:8070', '_blank');
    }

    function testDatabaseConnection() {
      const statusElement = document.getElementById('db-status');
      statusElement.textContent = 'Estado: Verificando...';
      
      // Simular verificación de base de datos
      setTimeout(() => {
        statusElement.textContent = 'Estado: PostgreSQL disponible en puerto 5432';
      }, 1500);
    }
  </script>

  <style>
    .status-indicator {
      text-align: center;
      margin: 20px 0;
    }

    .status-loading {
      color: #f39c12;
    }

    .status-online {
      color: #27ae60;
      font-weight: bold;
    }

    .status-offline {
      color: #e74c3c;
      font-weight: bold;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      border-left: 4px solid #3498db;
    }

    .stats-content {
      margin-top: 15px;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      padding: 8px 0;
      border-bottom: 1px solid #ecf0f1;
    }

    .stat-label {
      font-weight: 500;
    }

    .stat-value {
      font-weight: bold;
      color: #3498db;
    }

    .tools-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 25px;
      margin: 30px 0;
    }

    .tool-card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      border-top: 4px solid #e74c3c;
    }

    .cotizacion-form {
      margin-top: 15px;
    }

    .cotizacion-form label {
      display: block;
      margin: 10px 0 5px 0;
      font-weight: 500;
    }

    .cotizacion-form input,
    .cotizacion-form select {
      width: 100%;
      padding: 8px;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      margin-bottom: 10px;
    }

    .activities-container {
      max-height: 400px;
      overflow-y: auto;
      background: white;
      border-radius: 8px;
      padding: 20px;
    }

    .activity-item {
      display: flex;
      align-items: center;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      background: #f8f9fa;
      border-left: 4px solid #95a5a6;
    }

    .activity-item.success {
      border-left-color: #27ae60;
    }

    .activity-item.error {
      border-left-color: #e74c3c;
    }

    .activity-type {
      font-size: 24px;
      margin-right: 15px;
    }

    .activity-content {
      flex: 1;
    }

    .activity-message {
      margin: 0;
      font-weight: 500;
    }

    .activity-time {
      color: #7f8c8d;
    }

    .integration-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .integration-card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      border-top: 4px solid #9b59b6;
    }

    .integration-links {
      margin-top: 15px;
    }

    .integration-links a,
    .integration-links button {
      margin: 5px 10px 5px 0;
    }

    .integration-info {
      margin: 10px 0;
      color: #7f8c8d;
      font-size: 14px;
    }

    .integration-info code {
      background: #ecf0f1;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
  </style>
